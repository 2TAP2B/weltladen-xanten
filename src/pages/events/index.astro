---
import BaseLayout from "../../layouts/BaseLayout.astro";
import PageHeader from "../../components/Sections/PageHeader.astro";
import Card from "../../components/UI/Card.astro";
import { getEvents, getAssetUrl } from "../../utils/directus";

const events = await getEvents();

// Helper function to format date
function formatDate(dateString: string) {
  const date = new Date(dateString);
  return date.toLocaleDateString('de-DE', { 
    weekday: 'long',
    year: 'numeric', 
    month: 'long', 
    day: 'numeric' 
  });
}

// Helper function to format date range
function formatDateRange(startDate: string, endDate?: string | null) {
  if (!endDate || startDate === endDate) {
    return formatDate(startDate);
  }
  
  const start = new Date(startDate);
  const end = new Date(endDate);
  
  if (start.getMonth() === end.getMonth() && start.getFullYear() === end.getFullYear()) {
    return `${start.getDate()}. - ${end.getDate()}. ${start.toLocaleDateString('de-DE', { month: 'long', year: 'numeric' })}`;
  }
  
  return `${formatDate(startDate)} - ${formatDate(endDate)}`;
}

// Separate upcoming and past events
const now = new Date();
const upcomingEvents = events.filter(event => {
  const eventEnd = event.end_date || event.event_date;
  return new Date(eventEnd) >= now;
});
const pastEvents = events.filter(event => {
  const eventEnd = event.end_date || event.event_date;
  return new Date(eventEnd) < now;
});
---

<BaseLayout
  title="Veranstaltungen - Weltladen Xanten"
  description="Entdecken Sie unsere kommenden Veranstaltungen rund um fairen Handel, Nachhaltigkeit und globale Gerechtigkeit."
>
  <PageHeader 
    title="Veranstaltungen" 
    subtitle="Lernen Sie mehr Ã¼ber fairen Handel und nachhaltige Entwicklung"
    backgroundImage="/uploads/events-header-bg.webp"
  />
  
  <section class="py-16 dark:bg-gray-900">
    <div class="container">
      <h2 class="text-3xl md:text-4xl font-bold mb-8 dark:text-white">Kommende Veranstaltungen</h2>
      
      {upcomingEvents.length > 0 ? (
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {upcomingEvents.map((event) => (
            <Card
              title={event.title}
              image={event.featured_image ? {
                src: getAssetUrl(event.featured_image, { width: 800, height: 600, fit: 'cover', quality: 80 }),
                alt: event.title
              } : undefined}
              href={`/events/${event.slug}`}
              className="dark:bg-gray-800"
            >
              <div class="space-y-2">
                <div class="flex items-start text-gray-600 dark:text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-sm">{formatDateRange(event.event_date, event.end_date)}</span>
                </div>
                
                {event.time && (
                  <div class="flex items-start text-gray-600 dark:text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                    <span class="text-sm">{event.time}</span>
                  </div>
                )}
                
                {event.location && (
                  <div class="flex items-start text-gray-600 dark:text-gray-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17.657 16.657L13.414 20.9a1.998 1.998 0 01-2.827 0l-4.244-4.243a8 8 0 1111.314 0z" />
                      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 11a3 3 0 11-6 0 3 3 0 016 0z" />
                    </svg>
                    <span class="text-sm">{event.location}</span>
                  </div>
                )}
                
                {event.summary && (
                  <p class="text-gray-700 dark:text-gray-300 text-sm mt-4 line-clamp-3">
                    {event.summary}
                  </p>
                )}
                
                {event.registration_required && (
                  <span class="inline-block mt-4 px-3 py-1 bg-orange-100 dark:bg-orange-900/30 text-orange-600 dark:text-orange-400 text-xs font-semibold rounded-full">
                    Anmeldung erforderlich
                  </span>
                )}
              </div>
            </Card>
          ))}
        </div>
      ) : (
        <div class="text-center py-12 bg-gray-50 dark:bg-gray-800 rounded-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="h-16 w-16 mx-auto text-gray-400 dark:text-gray-600 mb-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
          </svg>
          <p class="text-gray-600 dark:text-gray-400 text-lg">
            Derzeit sind keine kommenden Veranstaltungen geplant.
          </p>
          <p class="text-gray-500 dark:text-gray-500 mt-2">
            Schauen Sie bald wieder vorbei oder kontaktieren Sie uns fÃ¼r weitere Informationen.
          </p>
        </div>
      )}
    </div>
  </section>
  
  {pastEvents.length > 0 && (
    <section class="py-16 bg-gray-50 dark:bg-gray-800">
      <div class="container">
        <h2 class="text-3xl md:text-4xl font-bold mb-8 dark:text-white">Vergangene Veranstaltungen</h2>
        
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-8">
          {pastEvents.slice(0, 6).map((event) => (
            <Card
              title={event.title}
              image={event.featured_image ? {
                src: getAssetUrl(event.featured_image, { width: 800, height: 600, fit: 'cover', quality: 80 }),
                alt: event.title
              } : undefined}
              href={`/events/${event.slug}`}
              className="dark:bg-gray-700 opacity-90"
            >
              <div class="space-y-2">
                <div class="flex items-start text-gray-600 dark:text-gray-400">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 mr-2 mt-0.5 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                  </svg>
                  <span class="text-sm">{formatDateRange(event.event_date, event.end_date)}</span>
                </div>
                
                {event.summary && (
                  <p class="text-gray-700 dark:text-gray-300 text-sm mt-4 line-clamp-3">
                    {event.summary}
                  </p>
                )}
              </div>
            </Card>
          ))}
        </div>
      </div>
    </section>
  )}
</BaseLayout>
